---
- name: Check if error_page directive is set in server block
  loop: "{{ _server_block.error_page | default([]) }}"
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: >-
      {{ '    ' }}error_page {{ item.codes | join(' ') -}}
        {{- ' ' + item.response if item.response is defined -}}
        {{- ' ' + item.uri }};
    owner: root
    group: root
    mode: '0640'
  register: _error_page_directive

- name: Verify error_page directive is set in server block
  loop: "{{ _error_page_directive.results }}"
  ansible.builtin.assert:
    that:
      - not item.changed
    fail_msg: error_page directive is not set in server block.
    success_msg: error_page directive is set in server block.
  loop_control:
    label: "{{ item.item }}"

- name: Check if limit_rate directive is set in server block
  when:
    - _server_block.limit_rate is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    limit_rate {{ _server_block.limit_rate }};"
    owner: root
    group: root
    mode: '0640'
  register: _limit_rate_directive

- name: Verify limit_rate directive is set in server block
  when:
    - _server_block.limit_rate is defined
  ansible.builtin.assert:
    that:
      - not _limit_rate_directive.changed
    fail_msg: limit_rate directive is not set in server block.
    success_msg: limit_rate directive is set in server block.

- name: Check if root directive is set in server block
  when:
    - _server_block.root is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    root {{ _server_block.root }};"
    owner: root
    group: root
    mode: '0640'
  register: _root_directive

- name: Verify root directive is set in server block
  when:
    - _server_block.root is defined
  ansible.builtin.assert:
    that:
      - not _root_directive.changed
    fail_msg: root directive is not set in server block.
    success_msg: root directive is set in server block.

- name: Check if sendfile directive is set in server block
  when:
    - _server_block.sendfile is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    sendfile {{ _server_block.sendfile | ternary('on', 'off') }};"
    owner: root
    group: root
    mode: '0640'
  register: _sendfile_directive

- name: Verify sendfile directive is set in server block
  when:
    - _server_block.sendfile is defined
  ansible.builtin.assert:
    that:
      - not _sendfile_directive.changed
    fail_msg: sendfile directive is not set in server block.
    success_msg: sendfile directive is set in server block.

- name: Check if absolute_redirect directive is set in server block
  when:
    - _server_block.absolute_redirect is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    absolute_redirect {{ _server_block.absolute_redirect | ternary('on', 'off') }};"
    owner: root
    group: root
    mode: '0640'
  register: _absolute_redirect_directive

- name: Verify absolute_redirect directive is set in server block
  when:
    - _server_block.absolute_redirect is defined
  ansible.builtin.assert:
    that:
      - not _absolute_redirect_directive.changed
    fail_msg: absolute_redirect directive is not set in server block.
    success_msg: absolute_redirect directive is set in server block.

- name: Check if aio directive is set in server block
  when:
    - _server_block.aio is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    aio {{ _server_block.aio | ternary('on', 'off') }};"
    owner: root
    group: root
    mode: '0640'
  register: _aio_directive

- name: Verify aio directive is set in server block
  when:
    - _server_block.aio is defined
  ansible.builtin.assert:
    that:
      - not _aio_directive.changed
    fail_msg: aio directive is not set in server block.
    success_msg: aio directive is set in server block.

- name: Check if auth_delay directive is set in server block
  when:
    - _server_block.auth_delay is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    auth_delay {{ _server_block.auth_delay }};"
    owner: root
    group: root
    mode: '0640'
  register: _auth_delay_directive

- name: Verify auth_delay directive is set in server block
  when:
    - _server_block.auth_delay is defined
  ansible.builtin.assert:
    that:
      - not _auth_delay_directive.changed
    fail_msg: auth_delay directive is not set in server block.
    success_msg: auth_delay directive is set in server block.

- name: Check if chunked_transfer_encoding directive is set in server block
  when:
    - _server_block.chunked_transfer_encoding is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    chunked_transfer_encoding {{ _server_block.chunked_transfer_encoding | ternary('on', 'off') }};"
    owner: root
    group: root
    mode: '0640'
  register: _chunked_transfer_encoding_directive

- name: Verify chunked_transfer_encoding directive is set in server block
  when:
    - _server_block.chunked_transfer_encoding is defined
  ansible.builtin.assert:
    that:
      - not _chunked_transfer_encoding_directive.changed
    fail_msg: chunked_transfer_encoding directive is not set in server block.
    success_msg: chunked_transfer_encoding directive is set in server block.

- name: Check if client_body_buffer_size directive is set in server block
  when:
    - _server_block.client_body_buffer_size is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    client_body_buffer_size {{ _server_block.client_body_buffer_size }};"
    owner: root
    group: root
    mode: '0640'
  register: _client_body_buffer_size_directive

- name: Verify client_body_buffer_size directive is set in server block
  when:
    - _server_block.client_body_buffer_size is defined
  ansible.builtin.assert:
    that:
      - not _client_body_buffer_size_directive.changed
    fail_msg: client_body_buffer_size directive is not set in server block.
    success_msg: client_body_buffer_size directive is set in server block.

- name: Check if client_body_in_file_only directive is set in server block
  when:
    - _server_block.client_body_in_file_only is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    client_body_in_file_only {{ _server_block.client_body_in_file_only }};"
    owner: root
    group: root
    mode: '0640'
  register: _client_body_in_file_only_directive

- name: Verify client_body_in_file_only directive is set in server block
  when:
    - _server_block.client_body_in_file_only is defined
  ansible.builtin.assert:
    that:
      - not _client_body_in_file_only_directive.changed
    fail_msg: client_body_in_file_only directive is not set in server block.
    success_msg: client_body_in_file_only directive is set in server block.

- name: Check if client_body_in_single_buffer directive is set in server block
  when:
    - _server_block.client_body_in_single_buffer is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    client_body_in_single_buffer {{ _server_block.client_body_in_single_buffer | ternary('on', 'off') }};"
    owner: root
    group: root
    mode: '0640'
  register: _client_body_in_single_buffer_directive

- name: Verify client_body_in_single_buffer directive is set in server block
  when:
    - _server_block.client_body_in_single_buffer is defined
  ansible.builtin.assert:
    that:
      - not _client_body_in_single_buffer_directive.changed
    fail_msg: client_body_in_single_buffer directive is not set in server block.
    success_msg: client_body_in_single_buffer directive is set in server block.

- name: Check if client_body_temp_path directive is set in server block
  when:
    - _server_block.client_body_temp_path is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: >-
      {{ '    ' }}client_body_temp_path {{ _server_block.client_body_temp_path.path -}}
        {{- ' 1' if _server_block.client_body_temp_path.level | default(0) > 0 -}}
        {{- ' 2' if _server_block.client_body_temp_path.level | default(0) > 1 -}}
        {{- ' 3' if _server_block.client_body_temp_path.level | default(0) > 2 }};
    owner: root
    group: root
    mode: '0640'
  register: _client_body_temp_path_directive

- name: Verify client_body_temp_path directive is set in server block
  when:
    - _server_block.client_body_temp_path is defined
  ansible.builtin.assert:
    that:
      - not _client_body_temp_path_directive.changed
    fail_msg: client_body_temp_path directive is not set in server block.
    success_msg: client_body_temp_path directive is set in server block.

- name: Check if client_body_timeout directive is set in server block
  when:
    - _server_block.client_body_timeout is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    client_body_timeout {{ _server_block.client_body_timeout }};"
    owner: root
    group: root
    mode: '0640'
  register: _client_body_timeout_directive

- name: Verify client_body_timeout directive is set in server block
  when:
    - _server_block.client_body_timeout is defined
  ansible.builtin.assert:
    that:
      - not _client_body_timeout_directive.changed
    fail_msg: client_body_timeout directive is not set in server block.
    success_msg: client_body_timeout directive is set in server block.

- name: Check if client_max_body_size directive is set in server block
  when:
    - _server_block.client_max_body_size is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    client_max_body_size {{ _server_block.client_max_body_size }};"
    owner: root
    group: root
    mode: '0640'
  register: _client_max_body_size_directive

- name: Verify client_max_body_size directive is set in server block
  when:
    - _server_block.client_max_body_size is defined
  ansible.builtin.assert:
    that:
      - not _client_max_body_size_directive.changed
    fail_msg: client_max_body_size directive is not set in server block.
    success_msg: client_max_body_size directive is set in server block.

- name: Check if default_type directive is set in server block
  when:
    - _server_block.default_type is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    default_type {{ _server_block.default_type }};"
    owner: root
    group: root
    mode: '0640'
  register: _default_type_directive

- name: Verify default_type directive is set in server block
  when:
    - _server_block.default_type is defined
  ansible.builtin.assert:
    that:
      - not _default_type_directive.changed
    fail_msg: default_type directive is not set in server block.
    success_msg: default_type directive is set in server block.

- name: Check if directio directive is set in server block
  when:
    - _server_block.directio is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    directio {{ _server_block.directio }};"
    owner: root
    group: root
    mode: '0640'
  register: _directio_directive

- name: Verify directio directive is set in server block
  when:
    - _server_block.directio is defined
  ansible.builtin.assert:
    that:
      - not _directio_directive.changed
    fail_msg: directio directive is not set in server block.
    success_msg: directio directive is set in server block.

- name: Check if directio_alignment directive is set in server block
  when:
    - _server_block.directio_alignment is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    directio_alignment {{ _server_block.directio_alignment }};"
    owner: root
    group: root
    mode: '0640'
  register: _directio_alignment_directive

- name: Verify directio_alignment directive is set in server block
  when:
    - _server_block.directio_alignment is defined
  ansible.builtin.assert:
    that:
      - not _directio_alignment_directive.changed
    fail_msg: directio_alignment directive is not set in server block.
    success_msg: directio_alignment directive is set in server block.

- name: Check if disable_symlinks directive is set in server block (off)
  when:
    - _server_block.disable_symlinks is defined
    - _server_block.disable_symlinks.off | default(false)
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    disable_symlinks off;"
    owner: root
    group: root
    mode: '0640'
  register: _disable_symlinks_off_directive

- name: Verify disable_symlinks directive is set in server block (off)
  when:
    - _server_block.disable_symlinks is defined
    - _server_block.disable_symlinks.off | default(false)
  ansible.builtin.assert:
    that:
      - not _disable_symlinks_off_directive.changed
    fail_msg: disable_symlinks directive is not set in server block.
    success_msg: disable_symlinks directive is set in server block.

- name: Check if disable_symlinks directive is set in server block (if_not_owner)
  when:
    - _server_block.disable_symlinks is defined
    - not _server_block.disable_symlinks.off | default(false)
    - _server_block.disable_symlinks.if_not_owner | default(false)
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    disable_symlinks if_not_owner{{ ' from=' + _server_block.disable_symlinks.from | string if _server_block.disable_symlinks.from is defined }};"
    owner: root
    group: root
    mode: '0640'
  register: _disable_symlinks_if_not_owner_directive

- name: Verify disable_symlinks directive is set in server block (if_not_owner)
  when:
    - _server_block.disable_symlinks is defined
    - not _server_block.disable_symlinks.off | default(false)
    - _server_block.disable_symlinks.if_not_owner | default(false)
  ansible.builtin.assert:
    that:
      - not _disable_symlinks_if_not_owner_directive.changed
    fail_msg: disable_symlinks directive is not set in server block.
    success_msg: disable_symlinks directive is set in server block.

- name: Check if disable_symlinks directive is set in server block
  when:
    - _server_block.disable_symlinks is defined
    - not _server_block.disable_symlinks.off | default(false)
    - not _server_block.disable_symlinks.if_not_owner | default(false)
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    disable_symlinks on{{ ' from=' + _server_block.disable_symlinks.from | string if _server_block.disable_symlinks.from is defined }};"
    owner: root
    group: root
    mode: '0640'
  register: _disable_symlinks_directive

- name: Verify disable_symlinks directive is set in server block
  when:
    - _server_block.disable_symlinks is defined
    - not _server_block.disable_symlinks.off | default(false)
    - not _server_block.disable_symlinks.if_not_owner | default(false)
  ansible.builtin.assert:
    that:
      - not _disable_symlinks_directive.changed
    fail_msg: disable_symlinks directive is not set in server block.
    success_msg: disable_symlinks directive is set in server block.

- name: Check if etag directive is set in server block
  when:
    - _server_block.etag is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    etag {{ _server_block.etag | ternary('on', 'off') }};"
    owner: root
    group: root
    mode: '0640'
  register: _etag_directive

- name: Verify etag directive is set in server block
  when:
    - _server_block.etag is defined
  ansible.builtin.assert:
    that:
      - not _etag_directive.changed
    fail_msg: etag directive is not set in server block.
    success_msg: etag directive is set in server block.

- name: Check if if_modified_since directive is set in server block
  when:
    - _server_block.if_modified_since is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    if_modified_since {{ _server_block.if_modified_since }};"
    owner: root
    group: root
    mode: '0640'
  register: _if_modified_since_directive

- name: Verify if_modified_since directive is set in server block
  when:
    - _server_block.if_modified_since is defined
  ansible.builtin.assert:
    that:
      - not _if_modified_since_directive.changed
    fail_msg: if_modified_since directive is not set in server block.
    success_msg: if_modified_since directive is set in server block.

- name: Check if keepalive_disable directive is set in server block
  when:
    - _server_block.keepalive_disable is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    keepalive_disable {{ 'none' if _server_block.keepalive_disable.none | default(false) else _server_block.keepalive_disable.browsers | join(' ') }};"
    owner: root
    group: root
    mode: '0640'
  register: _keepalive_disable_directive

- name: Verify keepalive_disable directive is set in server block
  when:
    - _server_block.keepalive_disable is defined
  ansible.builtin.assert:
    that:
      - not _keepalive_disable_directive.changed
    fail_msg: keepalive_disable directive is not set in server block.
    success_msg: keepalive_disable directive is set in server block.

- name: Check if keepalive_requests directive is set in server block
  when:
    - _server_block.keepalive_requests is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    keepalive_requests {{ _server_block.keepalive_requests }};"
    owner: root
    group: root
    mode: '0640'
  register: _keepalive_requests_directive

- name: Verify keepalive_requests directive is set in server block
  when:
    - _server_block.keepalive_requests is defined
  ansible.builtin.assert:
    that:
      - not _keepalive_requests_directive.changed
    fail_msg: keepalive_requests directive is not set in server block.
    success_msg: keepalive_requests directive is set in server block.

- name: Check if keepalive_time directive is set in server block
  when:
    - _server_block.keepalive_time is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    keepalive_time {{ _server_block.keepalive_time }};"
    owner: root
    group: root
    mode: '0640'
  register: _keepalive_time_directive

- name: Verify keepalive_time directive is set in server block
  when:
    - _server_block.keepalive_time is defined
  ansible.builtin.assert:
    that:
      - not _keepalive_time_directive.changed
    fail_msg: keepalive_time directive is not set in server block.
    success_msg: keepalive_time directive is set in server block.

- name: Check if keepalive_timeout directive is set in server block
  when:
    - _server_block.keepalive_timeout is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: >-
      {{ '    ' }}keepalive_timeout {{ _server_block.keepalive_timeout.timeout -}}
        {{- ' ' + _server_block.keepalive_timeout.header_timeout | string if _server_block.keepalive_timeout.header_timeout is defined }};
    owner: root
    group: root
    mode: '0640'
  register: _keepalive_timeout_directive

- name: Verify keepalive_timeout directive is set in server block
  when:
    - _server_block.keepalive_timeout is defined
  ansible.builtin.assert:
    that:
      - not _keepalive_timeout_directive.changed
    fail_msg: keepalive_timeout directive is not set in server block.
    success_msg: keepalive_timeout directive is set in server block.

- name: Check if lingering_close directive is set in server block
  when:
    - _server_block.lingering_close is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    lingering_close {{ _server_block.lingering_close }};"
    owner: root
    group: root
    mode: '0640'
  register: _lingering_close_directive

- name: Verify lingering_close directive is set in server block
  when:
    - _server_block.lingering_close is defined
  ansible.builtin.assert:
    that:
      - not _lingering_close_directive.changed
    fail_msg: lingering_close directive is not set in server block.
    success_msg: lingering_close directive is set in server block.

- name: Check if lingering_time directive is set in server block
  when:
    - _server_block.lingering_time is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    lingering_time {{ _server_block.lingering_time }};"
    owner: root
    group: root
    mode: '0640'
  register: _lingering_time_directive

- name: Verify lingering_time directive is set in server block
  when:
    - _server_block.lingering_time is defined
  ansible.builtin.assert:
    that:
      - not _lingering_time_directive.changed
    fail_msg: lingering_time directive is not set in server block.
    success_msg: lingering_time directive is set in server block.

- name: Check if lingering_timeout directive is set in server block
  when:
    - _server_block.lingering_timeout is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    lingering_timeout {{ _server_block.lingering_timeout }};"
    owner: root
    group: root
    mode: '0640'
  register: _lingering_timeout_directive

- name: Verify lingering_timeout directive is set in server block
  when:
    - _server_block.lingering_timeout is defined
  ansible.builtin.assert:
    that:
      - not _lingering_timeout_directive.changed
    fail_msg: lingering_timeout directive is not set in server block.
    success_msg: lingering_timeout directive is set in server block.

- name: Check if log_not_found directive is set in server block
  when:
    - _server_block.log_not_found is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    log_not_found {{ _server_block.log_not_found | ternary('on', 'off') }};"
    owner: root
    group: root
    mode: '0640'
  register: _log_not_found_directive

- name: Verify log_not_found directive is set in server block
  when:
    - _server_block.log_not_found is defined
  ansible.builtin.assert:
    that:
      - not _log_not_found_directive.changed
    fail_msg: log_not_found directive is not set in server block.
    success_msg: log_not_found directive is set in server block.

- name: Check if log_subrequest directive is set in server block
  when:
    - _server_block.log_subrequest is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    log_subrequest {{ _server_block.log_subrequest | ternary('on', 'off') }};"
    owner: root
    group: root
    mode: '0640'
  register: _log_subrequest_directive

- name: Verify log_subrequest directive is set in server block
  when:
    - _server_block.log_subrequest is defined
  ansible.builtin.assert:
    that:
      - not _log_subrequest_directive.changed
    fail_msg: log_subrequest directive is not set in server block.
    success_msg: log_subrequest directive is set in server block.

- name: Check if max_ranges directive is set in server block
  when:
    - _server_block.max_ranges is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    max_ranges {{ _server_block.max_ranges }};"
    owner: root
    group: root
    mode: '0640'
  register: _max_ranges_directive

- name: Verify max_ranges directive is set in server block
  when:
    - _server_block.max_ranges is defined
  ansible.builtin.assert:
    that:
      - not _max_ranges_directive.changed
    fail_msg: max_ranges directive is not set in server block.
    success_msg: max_ranges directive is set in server block.

- name: Check if msie_padding directive is set in server block
  when:
    - _server_block.msie_padding is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    msie_padding {{ _server_block.msie_padding | ternary('on', 'off') }};"
    owner: root
    group: root
    mode: '0640'
  register: _msie_padding_directive

- name: Verify msie_padding directive is set in server block
  when:
    - _server_block.msie_padding is defined
  ansible.builtin.assert:
    that:
      - not _msie_padding_directive.changed
    fail_msg: msie_padding directive is not set in server block.
    success_msg: msie_padding directive is set in server block.

- name: Check if msie_refresh directive is set in server block
  when:
    - _server_block.msie_refresh is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    msie_refresh {{ _server_block.msie_refresh | ternary('on', 'off') }};"
    owner: root
    group: root
    mode: '0640'
  register: _msie_refresh_directive

- name: Verify msie_refresh directive is set in server block
  when:
    - _server_block.msie_refresh is defined
  ansible.builtin.assert:
    that:
      - not _msie_refresh_directive.changed
    fail_msg: msie_refresh directive is not set in server block.
    success_msg: msie_refresh directive is set in server block.

- name: Check if open_file_cache directive is set in server block (off)
  when:
    - _server_block.open_file_cache is defined
    - _server_block.open_file_cache.off | default(false)
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    open_file_cache off;"
    owner: root
    group: root
    mode: '0640'
  register: _open_file_cache_off_directive

- name: Verify open_file_cache directive is set in server block (off)
  when:
    - _server_block.open_file_cache is defined
    - _server_block.open_file_cache.off | default(false)
  ansible.builtin.assert:
    that:
      - not _open_file_cache_off_directive.changed
    fail_msg: open_file_cache directive is not set in server block.
    success_msg: open_file_cache directive is set in server block.

- name: Check if open_file_cache directive is set in server block
  when:
    - _server_block.open_file_cache is defined
    - not _server_block.open_file_cache.off | default(false)
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: >-
      {{ '    ' }}open_file_cache max={{ _server_block.open_file_cache.max -}}
        {{- ' inactive=' + _server_block.open_file_cache.inactive | string if _server_block.open_file_cache.inactive is defined }};
    owner: root
    group: root
    mode: '0640'
  register: _open_file_cache_directive

- name: Verify open_file_cache directive is set in server block
  when:
    - _server_block.open_file_cache is defined
    - not _server_block.open_file_cache.off | default(false)
  ansible.builtin.assert:
    that:
      - not _open_file_cache_directive.changed
    fail_msg: open_file_cache directive is not set in server block.
    success_msg: open_file_cache directive is set in server block.

- name: Check if open_file_cache_errors directive is set in server block
  when:
    - _server_block.open_file_cache_errors is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    open_file_cache_errors {{ _server_block.open_file_cache_errors | ternary('on', 'off') }};"
    owner: root
    group: root
    mode: '0640'
  register: _open_file_cache_errors_directive

- name: Verify open_file_cache_errors directive is set in server block
  when:
    - _server_block.open_file_cache_errors is defined
  ansible.builtin.assert:
    that:
      - not _open_file_cache_errors_directive.changed
    fail_msg: open_file_cache_errors directive is not set in server block.
    success_msg: open_file_cache_errors directive is set in server block.

- name: Check if open_file_cache_min_uses directive is set in server block
  when:
    - _server_block.open_file_cache_min_uses is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    open_file_cache_min_uses {{ _server_block.open_file_cache_min_uses }};"
    owner: root
    group: root
    mode: '0640'
  register: _open_file_cache_min_uses_directive

- name: Verify open_file_cache_min_uses directive is set in server block
  when:
    - _server_block.open_file_cache_min_uses is defined
  ansible.builtin.assert:
    that:
      - not _open_file_cache_min_uses_directive.changed
    fail_msg: open_file_cache_min_uses directive is not set in server block.
    success_msg: open_file_cache_min_uses directive is set in server block.

- name: Check if open_file_cache_valid directive is set in server block
  when:
    - _server_block.open_file_cache_valid is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    open_file_cache_valid {{ _server_block.open_file_cache_valid }};"
    owner: root
    group: root
    mode: '0640'
  register: _open_file_cache_valid_directive

- name: Verify open_file_cache_valid directive is set in server block
  when:
    - _server_block.open_file_cache_valid is defined
  ansible.builtin.assert:
    that:
      - not _open_file_cache_valid_directive.changed
    fail_msg: open_file_cache_valid directive is not set in server block.
    success_msg: open_file_cache_valid directive is set in server block.

- name: Check if output_buffers directive is set in server block
  when:
    - _server_block.output_buffers is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    output_buffers {{ _server_block.output_buffers.count }} {{ _server_block.output_buffers.size }};"
    owner: root
    group: root
    mode: '0640'
  register: _output_buffers_directive

- name: Verify output_buffers directive is set in server block
  when:
    - _server_block.output_buffers is defined
  ansible.builtin.assert:
    that:
      - not _output_buffers_directive.changed
    fail_msg: output_buffers directive is not set in server block.
    success_msg: output_buffers directive is set in server block.

- name: Check if port_in_redirect directive is set in server block
  when:
    - _server_block.port_in_redirect is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    port_in_redirect {{ _server_block.port_in_redirect | ternary('on', 'off') }};"
    owner: root
    group: root
    mode: '0640'
  register: _port_in_redirect_directive

- name: Verify port_in_redirect directive is set in server block
  when:
    - _server_block.port_in_redirect is defined
  ansible.builtin.assert:
    that:
      - not _port_in_redirect_directive.changed
    fail_msg: port_in_redirect directive is not set in server block.
    success_msg: port_in_redirect directive is set in server block.

- name: Check if read_ahead directive is set in server block
  when:
    - _server_block.read_ahead is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    read_ahead {{ _server_block.read_ahead }};"
    owner: root
    group: root
    mode: '0640'
  register: _read_ahead_directive

- name: Verify read_ahead directive is set in server block
  when:
    - _server_block.read_ahead is defined
  ansible.builtin.assert:
    that:
      - not _read_ahead_directive.changed
    fail_msg: read_ahead directive is not set in server block.
    success_msg: read_ahead directive is set in server block.

- name: Check if recursive_error_pages directive is set in server block
  when:
    - _server_block.recursive_error_pages is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    recursive_error_pages {{ _server_block.recursive_error_pages | ternary('on', 'off') }};"
    owner: root
    group: root
    mode: '0640'
  register: _recursive_error_pages_directive

- name: Verify recursive_error_pages directive is set in server block
  when:
    - _server_block.recursive_error_pages is defined
  ansible.builtin.assert:
    that:
      - not _recursive_error_pages_directive.changed
    fail_msg: recursive_error_pages directive is not set in server block.
    success_msg: recursive_error_pages directive is set in server block.

- name: Check if reset_timedout_connection directive is set in server block
  when:
    - _server_block.reset_timedout_connection is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    reset_timedout_connection {{ _server_block.reset_timedout_connection | ternary('on', 'off') }};"
    owner: root
    group: root
    mode: '0640'
  register: _reset_timedout_connection_directive

- name: Verify reset_timedout_connection directive is set in server block
  when:
    - _server_block.reset_timedout_connection is defined
  ansible.builtin.assert:
    that:
      - not _reset_timedout_connection_directive.changed
    fail_msg: reset_timedout_connection directive is not set in server block.
    success_msg: reset_timedout_connection directive is set in server block.

- name: Check if resolver directive is set in server block
  loop: "{{ _server_block.resolver | default([]) }}"
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: >-
      {{ '    ' }}resolver {{ item.addresses | join(' ') -}}
        {{- ' valid=' + item.valid | string if item.valid is defined -}}
        {{- ' ipv4=' + item.ipv4 | ternary('on', 'off') if item.ipv4 is defined -}}
        {{- ' ipv6=' + item.ipv6 | ternary('on', 'off') if item.ipv6 is defined -}}
        {{- ' status_zone=' + item.status_zone | string if item.status_zone is defined }};
    owner: root
    group: root
    mode: '0640'
  register: _resolver_directive

- name: Verify resolver directive is set in server block
  loop: "{{ _resolver_directive.results }}"
  ansible.builtin.assert:
    that:
      - not item.changed
    fail_msg: resolver directive is not set in server block.
    success_msg: resolver directive is set in server block.
  loop_control:
    label: "{{ item.item }}"

- name: Check if resolver_timeout directive is set in server block
  when:
    - _server_block.resolver_timeout is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    resolver_timeout {{ _server_block.resolver_timeout }};"
    owner: root
    group: root
    mode: '0640'
  register: _resolver_timeout_directive

- name: Verify resolver_timeout directive is set in server block
  when:
    - _server_block.resolver_timeout is defined
  ansible.builtin.assert:
    that:
      - not _resolver_timeout_directive.changed
    fail_msg: resolver_timeout directive is not set in server block.
    success_msg: resolver_timeout directive is set in server block.

- name: Check if satisfy directive is set in server block
  when:
    - _server_block.satisfy is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    satisfy {{ _server_block.satisfy }};"
    owner: root
    group: root
    mode: '0640'
  register: _satisfy_directive

- name: Verify satisfy directive is set in server block
  when:
    - _server_block.satisfy is defined
  ansible.builtin.assert:
    that:
      - not _satisfy_directive.changed
    fail_msg: satisfy directive is not set in server block.
    success_msg: satisfy directive is set in server block.

- name: Check if send_lowat directive is set in server block
  when:
    - _server_block.send_lowat is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    send_lowat {{ _server_block.send_lowat }};"
    owner: root
    group: root
    mode: '0640'
  register: _send_lowat_directive

- name: Verify send_lowat directive is set in server block
  when:
    - _server_block.send_lowat is defined
  ansible.builtin.assert:
    that:
      - not _send_lowat_directive.changed
    fail_msg: send_lowat directive is not set in server block.
    success_msg: send_lowat directive is set in server block.

- name: Check if send_timeout directive is set in server block
  when:
    - _server_block.send_timeout is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    send_timeout {{ _server_block.send_timeout }};"
    owner: root
    group: root
    mode: '0640'
  register: _send_timeout_directive

- name: Verify send_timeout directive is set in server block
  when:
    - _server_block.send_timeout is defined
  ansible.builtin.assert:
    that:
      - not _send_timeout_directive.changed
    fail_msg: send_timeout directive is not set in server block.
    success_msg: send_timeout directive is set in server block.

- name: Check if server_name_in_redirect directive is set in server block
  when:
    - _server_block.server_name_in_redirect is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    server_name_in_redirect {{ _server_block.server_name_in_redirect | ternary('on', 'off') }};"
    owner: root
    group: root
    mode: '0640'
  register: _server_name_in_redirect_directive

- name: Verify server_name_in_redirect directive is set in server block
  when:
    - _server_block.server_name_in_redirect is defined
  ansible.builtin.assert:
    that:
      - not _server_name_in_redirect_directive.changed
    fail_msg: server_name_in_redirect directive is not set in server block.
    success_msg: server_name_in_redirect directive is set in server block.

- name: Check if server_tokens directive is set in server block
  when:
    - _server_block.server_tokens is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    server_tokens {{ _server_block.server_tokens }};"
    owner: root
    group: root
    mode: '0640'
  register: _server_tokens_directive

- name: Verify server_tokens directive is set in server block
  when:
    - _server_block.server_tokens is defined
  ansible.builtin.assert:
    that:
      - not _server_tokens_directive.changed
    fail_msg: server_tokens directive is not set in server block.
    success_msg: server_tokens directive is set in server block.

- name: Check if subrequest_output_buffer_size directive is set in server block
  when:
    - _server_block.subrequest_output_buffer_size is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    subrequest_output_buffer_size {{ _server_block.subrequest_output_buffer_size }};"
    owner: root
    group: root
    mode: '0640'
  register: _subrequest_output_buffer_size_directive

- name: Verify subrequest_output_buffer_size directive is set in server block
  when:
    - _server_block.subrequest_output_buffer_size is defined
  ansible.builtin.assert:
    that:
      - not _subrequest_output_buffer_size_directive.changed
    fail_msg: subrequest_output_buffer_size directive is not set in server block.
    success_msg: subrequest_output_buffer_size directive is set in server block.

- name: Check if tcp_nodelay directive is set in server block
  when:
    - _server_block.tcp_nodelay is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    tcp_nodelay {{ _server_block.tcp_nodelay | ternary('on', 'off') }};"
    owner: root
    group: root
    mode: '0640'
  register: _tcp_nodelay_directive

- name: Verify tcp_nodelay directive is set in server block
  when:
    - _server_block.tcp_nodelay is defined
  ansible.builtin.assert:
    that:
      - not _tcp_nodelay_directive.changed
    fail_msg: tcp_nodelay directive is not set in server block.
    success_msg: tcp_nodelay directive is set in server block.

- name: Check if tcp_nopush directive is set in server block
  when:
    - _server_block.tcp_nopush is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    tcp_nopush {{ _server_block.tcp_nopush | ternary('on', 'off') }};"
    owner: root
    group: root
    mode: '0640'
  register: _tcp_nopush_directive

- name: Verify tcp_nopush directive is set in server block
  when:
    - _server_block.tcp_nopush is defined
  ansible.builtin.assert:
    that:
      - not _tcp_nopush_directive.changed
    fail_msg: tcp_nopush directive is not set in server block.
    success_msg: tcp_nopush directive is set in server block.

- name: Check if types_hash_bucket_size directive is set in server block
  when:
    - _server_block.types_hash_bucket_size is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    types_hash_bucket_size {{ _server_block.types_hash_bucket_size }};"
    owner: root
    group: root
    mode: '0640'
  register: _types_hash_bucket_size_directive

- name: Verify types_hash_bucket_size directive is set in server block
  when:
    - _server_block.types_hash_bucket_size is defined
  ansible.builtin.assert:
    that:
      - not _types_hash_bucket_size_directive.changed
    fail_msg: types_hash_bucket_size directive is not set in server block.
    success_msg: types_hash_bucket_size directive is set in server block.

- name: Check if types_hash_max_size directive is set in server block
  when:
    - _server_block.types_hash_max_size is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    types_hash_max_size {{ _server_block.types_hash_max_size }};"
    owner: root
    group: root
    mode: '0640'
  register: _types_hash_max_size_directive

- name: Verify types_hash_max_size directive is set in server block
  when:
    - _server_block.types_hash_max_size is defined
  ansible.builtin.assert:
    that:
      - not _types_hash_max_size_directive.changed
    fail_msg: types_hash_max_size directive is not set in server block.
    success_msg: types_hash_max_size directive is set in server block.

- name: Check if client_header_buffer_size directive is set in server block
  when:
    - _server_block.client_header_buffer_size is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    client_header_buffer_size {{ _server_block.client_header_buffer_size }};"
    owner: root
    group: root
    mode: '0640'
  register: _client_header_buffer_size_directive

- name: Verify client_header_buffer_size directive is set in server block
  when:
    - _server_block.client_header_buffer_size is defined
  ansible.builtin.assert:
    that:
      - not _client_header_buffer_size_directive.changed
    fail_msg: client_header_buffer_size directive is not set in server block.
    success_msg: client_header_buffer_size directive is set in server block.

- name: Check if client_header_timeout directive is set in server block
  when:
    - _server_block.client_header_timeout is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    client_header_timeout {{ _server_block.client_header_timeout }};"
    owner: root
    group: root
    mode: '0640'
  register: _client_header_timeout_directive

- name: Verify client_header_timeout directive is set in server block
  when:
    - _server_block.client_header_timeout is defined
  ansible.builtin.assert:
    that:
      - not _client_header_timeout_directive.changed
    fail_msg: client_header_timeout directive is not set in server block.
    success_msg: client_header_timeout directive is set in server block.

- name: Check if connection_pool_size directive is set in server block
  when:
    - _server_block.connection_pool_size is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    connection_pool_size {{ _server_block.connection_pool_size }};"
    owner: root
    group: root
    mode: '0640'
  register: _connection_pool_size_directive

- name: Verify connection_pool_size directive is set in server block
  when:
    - _server_block.connection_pool_size is defined
  ansible.builtin.assert:
    that:
      - not _connection_pool_size_directive.changed
    fail_msg: connection_pool_size directive is not set in server block.
    success_msg: connection_pool_size directive is set in server block.

- name: Check if ignore_invalid_headers directive is set in server block
  when:
    - _server_block.ignore_invalid_headers is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    ignore_invalid_headers {{ _server_block.ignore_invalid_headers | ternary('on', 'off') }};"
    owner: root
    group: root
    mode: '0640'
  register: _ignore_invalid_headers_directive

- name: Verify ignore_invalid_headers directive is set in server block
  when:
    - _server_block.ignore_invalid_headers is defined
  ansible.builtin.assert:
    that:
      - not _ignore_invalid_headers_directive.changed
    fail_msg: ignore_invalid_headers directive is not set in server block.
    success_msg: ignore_invalid_headers directive is set in server block.

- name: Check if large_client_header_buffers directive is set in server block
  when:
    - _server_block.large_client_header_buffers is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    large_client_header_buffers {{ _server_block.large_client_header_buffers.count }} {{ _server_block.large_client_header_buffers.size }};"
    owner: root
    group: root
    mode: '0640'
  register: _large_client_header_buffers_directive

- name: Verify large_client_header_buffers directive is set in server block
  when:
    - _server_block.large_client_header_buffers is defined
  ansible.builtin.assert:
    that:
      - not _large_client_header_buffers_directive.changed
    fail_msg: large_client_header_buffers directive is not set in server block.
    success_msg: large_client_header_buffers directive is set in server block.

- name: Check if merge_slashes directive is set in server block
  when:
    - _server_block.merge_slashes is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    merge_slashes {{ _server_block.merge_slashes | ternary('on', 'off') }};"
    owner: root
    group: root
    mode: '0640'
  register: _merge_slashes_directive

- name: Verify merge_slashes directive is set in server block
  when:
    - _server_block.merge_slashes is defined
  ansible.builtin.assert:
    that:
      - not _merge_slashes_directive.changed
    fail_msg: merge_slashes directive is not set in server block.
    success_msg: merge_slashes directive is set in server block.

- name: Check if request_pool_size directive is set in server block
  when:
    - _server_block.request_pool_size is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    request_pool_size {{ _server_block.request_pool_size }};"
    owner: root
    group: root
    mode: '0640'
  register: _request_pool_size_directive

- name: Verify request_pool_size directive is set in server block
  when:
    - _server_block.request_pool_size is defined
  ansible.builtin.assert:
    that:
      - not _request_pool_size_directive.changed
    fail_msg: request_pool_size directive is not set in server block.
    success_msg: request_pool_size directive is set in server block.

- name: Check if underscores_in_headers directive is set in server block
  when:
    - _server_block.underscores_in_headers is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    underscores_in_headers {{ _server_block.underscores_in_headers | ternary('on', 'off') }};"
    owner: root
    group: root
    mode: '0640'
  register: _underscores_in_headers_directive

- name: Verify underscores_in_headers directive is set in server block
  when:
    - _server_block.underscores_in_headers is defined
  ansible.builtin.assert:
    that:
      - not _underscores_in_headers_directive.changed
    fail_msg: underscores_in_headers directive is not set in server block.
    success_msg: underscores_in_headers directive is set in server block.

- name: Check if try_files directive is set in server block
  loop: "{{ _server_block.try_files | default([]) }}"
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    try_files {{ item.files | join(' ') }} {{ item.response }};"
    owner: root
    group: root
    mode: '0640'
  register: _try_files_directive

- name: Verify try_files directive is set in server block
  loop: "{{ _try_files_directive.results }}"
  ansible.builtin.assert:
    that:
      - not item.changed
    fail_msg: try_files directive is not set in server block.
    success_msg: try_files directive is set in server block.
  loop_control:
    label: "{{ item.item }}"

- name: Check if listen directive is set in server block
  loop: "{{ _server_block.listen | default([]) }}"
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: >-
      {{ '    ' }}listen {{ item.address if item.address is defined -}}
        {{- ':' if item.address is defined and item.port is defined -}}
        {{- item.port if item.port is defined -}}
        {{- ' default_server' if item.default_server | default(false) -}}
        {{- ' ssl' if item.ssl | default(false) -}}
        {{- ' http2' if item.http2 | default(false) -}}
        {{- ' proxy_protocol' if item.proxy_protocol | default(false) -}}
        {{- ' setfib=' + item.setfib | string if item.setfib is defined -}}
        {{- ' fastopen=' + item.fastopen | string if item.fastopen is defined -}}
        {{- ' backlog=' + item.backlog | string if item.backlog is defined -}}
        {{- ' rcvbuf=' + item.rcvbuf | string if item.rcvbuf is defined -}}
        {{- ' sndbuf=' + item.sndbuf | string if item.sndbuf is defined -}}
        {{- ' accept_filter=' + item.accept_filter | string if item.accept_filter is defined -}}
        {{- ' deferred' if item.deferred | default(false) -}}
        {{- ' bind' if item.bind | default(false) -}}
        {{- ' ipv6only=' + item.ipv6only | ternary('on', 'off') if item.ipv6only is defined -}}
        {{- ' reuseport' if item.reuseport | default(false) -}}
        {%- if item.so_keepalive is defined -%}
        {%- if item.so_keepalive.on | default(false) -%}
        {{- ' so_keepalive=on' -}}
        {%- elif item.so_keepalive.off | default(false) -%}
        {{- ' so_keepalive=off' -}}
        {%- else -%}
        {{- ' so_keepalive=' -}}
        {{- item.so_keepalive.keepidle if item.so_keepalive.keepidle is defined -}}
        {{- ':' -}}
        {{- item.so_keepalive.keepintvl if item.so_keepalive.keepintvl is defined -}}
        {{- ':' -}}
        {{- item.so_keepalive.keepcnt if item.so_keepalive.keepcnt is defined -}}
        {%- endif -%}
        {%- endif %};
    owner: root
    group: root
    mode: '0640'
  register: _listen_directive

- name: Verify listen directive is set in server block
  loop: "{{ _listen_directive.results }}"
  ansible.builtin.assert:
    that:
      - not item.changed
    fail_msg: listen directive is not set in server block.
    success_msg: listen directive is set in server block.
  loop_control:
    label: "{{ item.item }}"

- name: Check if server_name directive is set in server block
  when:
    - _server_block.server_name is defined
  become: true
  check_mode: true
  ansible.builtin.lineinfile:
    path: "{{ _http_config_file.destination }}"
    insertafter: server {
    line: "    server_name {{ _server_block.server_name | join(' ') }};"
    owner: root
    group: root
    mode: '0640'
  register: _server_name_directive

- name: Verify server_name directive is set in server block
  when:
    - _server_block.server_name is defined
  ansible.builtin.assert:
    that:
      - not _server_name_directive.changed
    fail_msg: server_name directive is not set in server block.
    success_msg: server_name directive is set in server block.
